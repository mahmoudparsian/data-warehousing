

# Grouping, Aggregating, and Ranking in MySQL

---

## ðŸ“‘ Step 1: Schema and Sample Data

```sql
CREATE TABLE sales (
    sale_id INT PRIMARY KEY,
    product VARCHAR(20),
    region VARCHAR(20),
    amount DECIMAL(10,2)
);

INSERT INTO sales VALUES
(1, 'Laptop', 'North', 1200.00),
(2, 'Laptop', 'North', 1500.00),
(3, 'Phone', 'North', 800.00),
(4, 'Phone', 'South', 950.00),
(5, 'Tablet', 'South', 600.00),
(6, 'Tablet', 'East', 700.00),
(7, 'Laptop', 'East', 1000.00),
(8, 'Phone', 'East', 850.00);
```

ðŸ“Š **sales table**

| sale_id | product | region | amount  |
|---------|---------|--------|---------|
| 1       | Laptop  | North  | 1200.00 |
| 2       | Laptop  | North  | 1500.00 |
| 3       | Phone   | North  | 800.00  |
| 4       | Phone   | South  | 950.00  |
| 5       | Tablet  | South  | 600.00  |
| 6       | Tablet  | East   | 700.00  |
| 7       | Laptop  | East   | 1000.00 |
| 8       | Phone   | East   | 850.00  |

---

## ðŸ“‘ Step 2: Grouping Data with Aggregations

### Example 1: Total sales amount per region

```sql
SELECT 
       region, 
       SUM(amount) AS total_sales
FROM 
       sales
GROUP BY 
       region;
```

âœ… Output

| region | total_sales |
|--------|-------------|
| North  | 3500.00     |
| South  | 1550.00     |
| East   | 2550.00     |

---
### Example 1.1: Total sales amount per region where total sales over 2000 (filtering the result set (after agggregation))

```sql
SELECT 
       region, 
       SUM(amount) AS total_sales
FROM 
       sales
GROUP BY 
       region
HAVING 
       total_sales > 2000;
+--------+-------------+
| region | total_sales |
+--------+-------------+
| North  |     3500.00 |
| East   |     2550.00 |
+--------+-------------+
2 rows in set (0.000 sec)
       
```




---

### Example 2: Average sales amount per product

```sql
SELECT 
        product, 
        AVG(amount) AS avg_sales
FROM 
        sales
GROUP BY 
        product;
```

âœ… Output

| product | avg_sales |
|---------|-----------|
| Laptop  | 1233.33   |
| Phone   | 866.67    |
| Tablet  | 650.00    |

---

### Example 3: Minimum and Maximum sales amount per region

```sql
SELECT 
       region, 
       MIN(amount) AS min_sale, 
       MAX(amount) AS max_sale
FROM 
       sales
GROUP BY 
       region;
```

âœ… Output

| region | min_sale | max_sale |
|--------|----------|----------|
| North  | 800.00   | 1500.00  |
| South  | 600.00   | 950.00   |
| East   | 700.00   | 1000.00  |

-----

```sql
SELECT 
       region, 
       amount,
       MIN(amount) AS min_sale, 
       MAX(amount) AS max_sale
FROM 
       sales
GROUP BY 
       region;
===> ERROR: can not use "amount" column in the SELECT
ERROR 1055 (42000): Expression #2 of SELECT list is not 
in GROUP BY clause and contains nonaggregated column 'testdb.sales.amount' which is not functionally dependent 
on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by
```

```sql
SELECT 
       region, 
       GROUP_CONCAT(amount) AS list_of_amounts,
       MIN(amount) AS min_sale, 
       MAX(amount) AS max_sale
FROM 
       sales
GROUP BY 
       region;
+--------+------------------------+----------+----------+
| region | list_of_amounts        | min_sale | max_sale |
+--------+------------------------+----------+----------+
| East   | 700.00,1000.00,850.00  |   700.00 |  1000.00 |
| North  | 1200.00,1500.00,800.00 |   800.00 |  1500.00 |
| South  | 950.00,600.00          |   600.00 |   950.00 |
+--------+------------------------+----------+----------+
3 rows in set (0.000 sec)
```


----

### Example 4: Count number of sales per product

```sql
SELECT 
       product, 
       COUNT(*) AS num_sales
FROM 
       sales
GROUP BY 
       product;
```

âœ… Output

| product | num_sales |
|---------|-----------|
| Laptop  | 3         |
| Phone   | 3         |
| Tablet  | 2         |

---

## ðŸ“‘ Step 3: Ranking Data with RANK()

### Example 1: Rank regions by total sales

```sql
WITH Region_Sales AS (
  SELECT region, 
         SUM(amount) AS total_sales
  FROM 
         sales
  GROUP BY 
         region
)
SELECT 
       region, 
       total_sales,
       RANK() OVER (ORDER BY total_sales DESC) AS sales_rank
FROM 
       Region_Sales;
```

âœ… Output

| region | total_sales | sales_rank |
|--------|-------------|------------|
| North  | 3500.00     | 1          |
| East   | 2550.00     | 2          |
| South  | 1550.00     | 3          |

----

### Example 1.1: Find Top region based on total-sales. 

```sql
WITH 
Region_Sales AS (
  SELECT region, 
         SUM(amount) AS total_sales
  FROM 
         sales
  GROUP BY 
         region
)
,
RANKED_REGION AS (
  SELECT 
       region, 
       total_sales,
       RANK() OVER (ORDER BY total_sales DESC) AS sales_rank
  FROM 
       Region_Sales
)
SELECT region, 
       total_sales,
       sales_rank
FROM 
       RANKED_REGION
WHERE
       sales_rank <= 1; 
+--------+-------------+------------+
| region | total_sales | sales_rank |
+--------+-------------+------------+
| North  |     3500.00 |          1 |
+--------+-------------+------------+
1 row in set (0.000 sec) 
```

----

### Example 2: Rank products by average sales

```sql
WITH Product_Avg AS (
  SELECT 
          product, 
          AVG(amount) AS avg_sales
  FROM 
          sales
  GROUP BY 
          product
)
SELECT 
       product, 
       avg_sales,
       RANK() OVER (ORDER BY avg_sales DESC) AS avg_rank
FROM 
       Product_Avg;
```

âœ… Output

| product | avg_sales | avg_rank |
|---------|-----------|----------|
| Laptop  | 1233.33   | 1        |
| Phone   | 866.67    | 2        |
| Tablet  | 650.00    | 3        |

---

## ðŸ“‘ Step 4: Using DENSE_RANK()

ðŸ‘‰ `DENSE_RANK()` works like `RANK()`, but **without gaps** when there are ties.

### Example: Rank regions by total sales (dense)

```sql
WITH Region_Sales AS (
  SELECT 
         region, 
         SUM(amount) AS total_sales
  FROM 
         sales
  GROUP BY 
         region
)
SELECT 
       region, 
       total_sales,
       DENSE_RANK() OVER (ORDER BY total_sales DESC) AS dense_rank
FROM 
       Region_Sales;
```

âœ… Output

| region | total_sales | dense_rank |
|--------|-------------|------------|
| North  | 3500.00     | 1          |
| East   | 2550.00     | 2          |
| South  | 1550.00     | 3          |

*(Here results are the same, but in cases of ties, `RANK()` would skip numbers while `DENSE_RANK()` would not.)*

---

## ðŸ“‘ Step 5: Using ROW_NUMBER()

ðŸ‘‰ `ROW_NUMBER()` gives each row a unique sequential number, even if values tie.

### Example: Numbering products by average sales

```sql
WITH Product_Avg AS (
  SELECT 
         product, 
         AVG(amount) AS avg_sales
  FROM 
         sales
  GROUP BY 
         product
)
SELECT 
       product, 
       avg_sales,
       ROW_NUMBER() OVER (ORDER BY avg_sales DESC) AS rownum
FROM 
       Product_Avg;
```

âœ… Output

| product | avg_sales | rownum |
|---------|-----------|--------|
| Laptop  | 1233.33   | 1      |
| Phone   | 866.67    | 2      |
| Tablet  | 650.00    | 3      |

---

## ðŸ“‘ Key Takeaways

- **Grouping + Aggregation** lets you summarize data by categories.  

- Aggregates include: `SUM`, `AVG`, `MIN`, `MAX`, `COUNT`.  

- **RANK()** â†’ ranking with possible gaps in numbering.  

- **DENSE_RANK()** â†’ ranking with no gaps.  

- **ROW_NUMBER()** â†’ unique sequential number per row.  

- Combine `WITH` (CTEs) + ranking to make queries clearer.

---


# Two-Level of Grouping Using WITH (CTEs)

---

## ðŸ“‘ Step 1: Schema and Sample Data

```sql
CREATE TABLE sales (
    sale_id INT PRIMARY KEY,
    product VARCHAR(20),
    region VARCHAR(20),
    amount DECIMAL(10,2)
);

INSERT INTO sales VALUES
(1, 'Laptop', 'North', 1200.00),
(2, 'Laptop', 'North', 1500.00),
(3, 'Phone', 'North', 800.00),
(4, 'Phone', 'South', 950.00),
(5, 'Tablet', 'South', 600.00),
(6, 'Tablet', 'East', 700.00),
(7, 'Laptop', 'East', 1000.00),
(8, 'Phone', 'East', 850.00);
```

ðŸ“Š **sales table**

| sale_id | product | region | amount  |
|---------|---------|--------|---------|
| 1       | Laptop  | North  | 1200.00 |
| 2       | Laptop  | North  | 1500.00 |
| 3       | Phone   | North  | 800.00  |
| 4       | Phone   | South  | 950.00  |
| 5       | Tablet  | South  | 600.00  |
| 6       | Tablet  | East   | 700.00  |
| 7       | Laptop  | East   | 1000.00 |
| 8       | Phone   | East   | 850.00  |

---

## ðŸ“‘ Step 2: First-Level Grouping (per region + product)

ðŸ‘‰ Compute total sales per **region + product**.

```sql
WITH Region_Product_Sales AS (
  SELECT 
          region, 
          product, 
          SUM(amount) AS total_sales
  FROM 
          sales
  GROUP BY 
          region, product
)
SELECT * 
FROM Region_Product_Sales;
```

âœ… Output

| region | product | total_sales |
|--------|---------|-------------|
| North  | Laptop  | 2700.00     |
| North  | Phone   | 800.00      |
| South  | Phone   | 950.00      |
| South  | Tablet  | 600.00      |
| East   | Laptop  | 1000.00     |
| East   | Phone   | 850.00      |
| East   | Tablet  | 700.00      |

----

## Compute total sales per **region + product** if and only if the total sales is greater than 1000.

solution-1:

```sql
WITH Region_Product_Sales AS (
  SELECT 
          region, 
          product, 
          SUM(amount) AS total_sales
  FROM 
          sales
  GROUP BY 
          region, product
)
SELECT * 
FROM Region_Product_Sales
WHERE total_sales > 1000;
+--------+---------+-------------+
| region | product | total_sales |
+--------+---------+-------------+
| North  | Laptop  |     2700.00 |
+--------+---------+-------------+
1 row in set (0.000 sec)
```

OR

solution-2:

```sql
  SELECT 
          region, 
          product, 
          SUM(amount) AS total_sales
  FROM 
          sales
  GROUP BY 
          region, product
  HAVING
          total_sales > 1000;
+--------+---------+-------------+
| region | product | total_sales |
+--------+---------+-------------+
| North  | Laptop  |     2700.00 |
+--------+---------+-------------+
1 row in set (0.000 sec)
```
---

## ðŸ“‘ Step 3: Second-Level Grouping (per region)

ðŸ‘‰ Now group again on **region**, aggregating across products.

```sql
WITH Region_Product_Sales AS (
  SELECT 
         region, 
         product, 
         SUM(amount) AS total_sales
  FROM 
         sales
  GROUP BY 
         region, product
),
Region_Totals AS (
  SELECT 
         region, 
         SUM(total_sales) AS region_total
  FROM 
         Region_Product_Sales
  GROUP BY 
         region
)
SELECT * 
FROM Region_Totals;
```

âœ… Output

| region | region_total |
|--------|--------------|
| North  | 3500.00      |
| South  | 1550.00      |
| East   | 2550.00      |

---

## ðŸ“‘ Key Takeaways

- First CTE (`RegionProductSales`) â†’ groups by **region + product**.  

- Second CTE (`RegionTotals`) â†’ groups by **region** using the first result.  

- This is how you achieve **multi-level grouping** with subqueries.  

---



